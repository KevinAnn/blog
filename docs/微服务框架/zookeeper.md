# zookeeper

## 一、什么是zookeeper？

###        一、HTTP框架和Rpc框架的区别？

- rpc的优势在于高效的网络传输模型，以及针对服务调用场景专门设计协议和高效的序列化技术。

- http的优势在于它的成熟稳定、使用实现简单、被广泛的支持、兼容性良好、消息的可读性高。所以http协议在开房api、跨平台的服务间调用、对性能要求不苛刻的场景中有着广泛的使用。

  ### 二、 zookeeper的前世今生

  > zookeeper是一个高可靠得到分布式协调中间件。主要解决分布式一致性问题和分布式锁的问题

  #### 1.什么是分布式一致性问题？

  ​         什么是分布式一致性问题呢？简单来说，就是在一个分布式系统中，有多个节点，每个节点都会提出一个请求，但是在所有节点中只能确定一个请求被通过。而这个通过是需要所有节点达成一致的结果，所以所谓的一致性就是在提出的所有请求中能够选出最终一个确定请求。并且这个请求选出来以后，所有的节点都要知道。

  #### 2.分布式锁服务

  ​      从另外一个层面来看，Chubby 提供了一种粗粒度 的分布式锁服务， chubby 是通过创建文件的形式来提供锁的功能， server 向 chubby 中创建文件其实就表示加锁操作，创建文件成功表示抢占到了锁。 
  
  #### 3.zookeeper的设计猜想

  - 集群
- 数据同步
  
  - 自动选举

    关于数据同步

    leader节点可以处理事务和非事务数据。follower节点只能处理非事务性数据。

    

    ![image-20200715101613114](https://gitee.com/anqingjieer/pengbo/raw/master/img/20200715101624.png)

  #### 关于二阶段提交 

  ​	当一个事务操作需要跨越多个分布式节点的时候，为了保证事务处理的ACID特性，就需要引入一个协调者来统一调度所有分布式节点的执行逻辑，这些被调度的分布式节点被称为AP，TM负责调度ap的行为，并最终决定这些AP是否要把事务真正的进行提交；因为整个事务是分为两个阶段提交，所以叫为2pc.

###     3.zookeeoer的数据模型

> zookeeper的视图结构和标准的文件系统非常类似，每一个节点称之为 ZN ode 是 zookeeper 的最小单元。每个 znode上都可以保存数据以及挂载子节点。构成一个层次化的树形结构

- 持久节点，创建后会一直存在zookeeper服务器上，直到主动删除
- 持久有序节点 每个节点都会为它的一级子节点维护一个顺序。
- 临时节点  临时节点的生命周期和客户端的会话绑定在一起，当客户端会话失效改节点自动清理
- 临时有序节点   在临时节点的基础上多了一个顺序性

watcher

zookeeper提供了分布式数据的发布、订阅功能，zookeeper允许客户端向服务端注册一个watcher监听，当服务端的一些指定事件触发了watcher，那么服务端就会向客户端发送一个事件通知。

watcher通知是一次性的，一旦触发一次通知后，该watcher就失效了。

## 二、分布式锁的实现

​          我们可以通过  临时有序节点实现分布式锁，越早创建的节点，节点的顺序编号就越小，那么我们可以判断子节点中最小的节点设置为获得锁。如果自己的节点不是所有子节点中最小的，意味着还没有获得锁。这个的实现和前面单节点实现的差异性在于，每个节点只需要监听比自己小的节点，当比自己小的节点删除以后，客户端会收到 watcher 事件，此时再次判断自己的节点是不是所有子节点中最小的，如果是则获得锁，否则不断重复这个过程，这样就不会导致羊群效应，因为每个客户端只需要监控一个节点。

### 三、leader选举

Leader Latch

参与选举的所有节点，会创建一个顺序节点，其中 最小的节点会设置为 master 节点 没抢到 Leader 的节点都监听前一个节点的删除事件，在前一个节点删除后进行重新抢主 ，当 master 节点 手动调用 close （）方法或者 master节点挂了之后， 后续的子节点会抢占 master 。其中spark 使用的就是这种方法。

LeaderSelector

LeaderSelector 和 Leader Latch 最的差别在于， leader
可以释放领导权以后，还可以继续参与竞争

## 四、zk本身的leader选举

## 五、zk本身的数据同步









