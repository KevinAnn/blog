# redis实战

## 一、分布式方案

### 1.如何保证数据的分片？

#### 1）客户端进行分片

​					jdies提供了分片工具类。底层是用红黑树实现了一致性hash。

#### 2）服务端进行分片

​               Redis Cluster

数据分片有几个关键的问题需要解决：
      1、数据怎么相对均匀地分片

​             hash后取模，和hashmap一样   ，hash(key)%N

​             一致性hash算法

![image-20200603221101114](https://gitee.com/anqingjieer/pengbo/raw/master/img/20200603221101.png)

​             redis自用的

Redis 既没有用哈希取模，也没有用一致性哈希，而是用虚拟槽来实现的。

Redis 创建了16384 个槽（slot），每个节点负责一定区间的slot。比如Node1 负责0-5460，Node2 负责5461-10922，Node3 负责10923-16383。
Redis 的每个master 节点维护一个16384 位（2048bytes=2KB）的位序列，比如：序列的第0 位是1，就代表第一个slot 是它负责；序列的第1 位是0，代表第二个slot不归它负责。

对象分布到Redis 节点上时，对key 用CRC16 算法计算再%16384，得到一个slot
的值，数据落到负责这个slot 的Redis 节点上。

![image-20200603221344741](https://gitee.com/anqingjieer/pengbo/raw/master/img/20200603221344.png)

问题：怎么让相关的数据落到同一个节点上？

在key 里面加入{hash tag}即可。Redis 在计算槽编号的时候只会获取{}之间的字符
串进行槽编号计算，这样由于上面两个不同的键，{}里面的字符串是相同的，因此他们可
以被计算出相同的槽。



问题：客户端连接到哪一台服务器？访问的数据不在当前节点上，怎么办？

会进行重定向，连接下一个节点

```c
127.0.0.1:7291> set qs 1
(error) MOVED 13724 127.0.0.1:7293
```

