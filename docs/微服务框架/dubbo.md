# Dubbo

## 一、什么是Dubbo

> 主要是一个分布式服务治理解决方案，那么什么是服务治理？服务治理主要是针对大规模服务化以后，服务之间的路由、负载均衡、容错机制、服务降级这些问题的解决方案，而 Dubbo 实现的不仅仅是远程服务通信，并且还解决了服务路由、负载、降级、容错等功能。

## 二、dubbo的基本使用

### 1.负载均衡

> ​        dubbo集成了zookeeper解决了服务注册以及动态感知的问题。当服务器存在多个节点的集群时，zookeeper会维护不同集群  节点，对于客户端而言，他需要一种负载均衡机制来实现目标服务的请求负载。通过负载均衡，可以让每一个服务器节点获得适合自己处理能力的负载。

**Dubbo中负载均衡的使用**

配置的属性名称：
roundrobin /random/ leastactive consistenthash

- RandomLoadBalance权重随机算法

  ​		它的算法思想很简单。假设我们有一组服务器servers = [A, B, C] C]，他们对应的权重为weights = [5, 3, 2] 2]，权重总和为 10 。就是命中A的概率是50%，B是30%，C是20%.

- LeastActiveLoadBalance   最少活跃调用数算法

  最少活跃调用数算法活跃调用数越小，表明该服务提供者效率越高，单位时间内可处理更多的请求这个是比较科学的负载均衡算法 。每个每个服务提供者对应一个活跃数active 。初始情况下，所有服务提供者活跃数均为 0 。每收到一个请求，活跃数加 1 ，完成请求后则将活跃数减 1 。在服务运行一段时间后，性 能好的服务提供者处理请求的速度更快，因此活跃数下降的也越快，此时这样的服务提供者能够优先获取到新的服务请求。

- ConsistentHashLoadBalance
  hash一致性算法 相同参数的请求总是发到同一提供者当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变。

- RoundRobinLoadBalance   加权轮询算法

  所谓轮询是指将请求轮流分配给每台服务器。举个例子，我们有三台服务器
  A 、 B 、 C 。我们将第一个请求分配给服务器 A ，第二个请求分配给服务器 B ，第三个请求分配给服务器 C ，第四个请求再次分配给服务器 A 。这个过程就叫做轮询。轮询是一种无状态负载均衡算法，实现简单，适用于每台服务器性能相近的场景下。但现实情况下，我们并不能保证每台服务器性能均相近。如果我们将等量的请求分配给性能较差的服务器，这显然是不合理的。因此，这个时候我们需要对轮询过程进行加权，以调控每台服务器的负载。经过加权后，每台服务器能够得到的请求数 比例，接近或等于他们的权重比。比如服务器 A 、 B 、 C 权重比为 5 :2:1 。那么在 8 次请求中，服务器 A 将收到其中的 5 次请求，服务器 B 会收到其中的 2 次请求，服务器 C 则收到其中的 1次请求

  ### 2.容错能力

  > ​         在分布式网络通信中，容错能力是必须要具备的，什么叫容错呢？从字面意思来看：容：是容忍， 错：是错误。 就是容忍错误的能力。
  >
  > ​        我们知道网络通信会有很多不确定因素，比如网络延迟、网络中断、服务异常等，会造成当前这次请求出现失败 。 当务 通信出现这个问题时 ，需要采取一定的措施 应对。而 dubbo 中提供了容错机制来优雅处理这种错误

  #### 	1.Failover Cluster失败自动切换

  ​					当出现失败时，重试其他服务器，通常用于读的操作，但是重试会带来更大的延迟，一般设置重试次数  retries="2"

  #### 	2.Failfast Cluster

  ​				快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。

  ####       3. Failsafe Cluster

  ​					失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。

  ####         4.Failback Cluster

  ​			失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。

  ####         5.Forking Cluster

  ​        		并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。
  ​      			可通过forks="2" 来设置最大并行数。

  

  ### 3.服务降级

  > 当某个非关键服务出现错误时，可以通过降级功能来临时屏蔽这个服务。降级可以有几个层面的分类： 自动降级和人工降级； 按照功能可以分为：读服务降级和写服务降级；

  - 对一些非核心服务进行人工降级，在大促之前通过降级开关关闭哪些推荐内容、评价等对主流程没有影响的功能
  - 故障降级，比如调用的远程服务挂了，网络故障、或者 RPC 服务返回异常。 那么可以直接降级，降级的方案比如设置默认值、采用兜底数据（系统推荐的行为广告挂了，可以提前准备静态页面做返回）等等
  - 限流降级，在秒杀这种流量比较集中并且流量特别大的情况下，因为突发访问量特别大可能会导致系统支撑不了。这个时候可以采用限流来限制访问量。当达到阀值时，后续的请求被降级，比如进入排队页面，比如跳转到错误页（活动太火爆，稍后重试等

  

基础需求：我们如果需要自己开发一个网络通信，需要考虑到

- 底层网络通信协议的处理
- 序列化和反序列化的处理工作

我认为到目前为止，还只是满足了通信的基础需求，但是当企业开始大规模的 服务化以后， 远程通信带来的弊端就越来越明显了。比如说

- ​	服务器链路变长了，如何实现对服务链路的跟踪和监控了
- ​    服务的大规模集群是的服务之间需要依赖第三方注册中心来解决服务的发现和感知
- ​     服务通信之间的异常，需要有一种保护机制防止一个节点故障引发大规模的系统障碍，所以要有容错机制
- ​     服务大规模集群会是的客户端需要引入负载均衡机制实现请求分发



## 三、spi机制



### 1.java的spi机制

Java SPI是jdk内置的一种动态加载扩展点的实现。

1. 需要子classpath下面创建一个目录，命名为：META-INF/service
2. 在该目录下创建一个properties文件，改文件需要满足一下几个条件
   -   文件名必须是扩展的接口的全路径名称
   -    文件内部描述的是该扩展接口的所有实现类
   - 文件的编码格式是UTF-8
3. 通过java.util.ServiceLoader的加载机制来发现

java spi的实际应用



jdbc驱动。

jdk本身的Driver是一个借口，里面没有实现，实现的机制交给 mysql  sqlserver的本身。

![image-20200716103428937](https://gitee.com/anqingjieer/pengbo/raw/master/img/20200716103504.png)

### 2.Dubbo的spi机制

java本身的spi机制的缺点

- 需要遍历所有的实现，并实例化，然后我们再循环中才能找到我们需要的实现
- 做不到自动注入和装配
- 不提供类似spring的IOC和aop功能





